name: CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    NODE_VERSION: '20'
    MONGO_CEC_ADMIN: ${{ secrets.MONGO_CEC_ADMIN }}
    MONGO_CEC_PASS: ${{ secrets.MONGO_CEC_PASS }}
    MONGO_CEC_CONN: ${{ secrets.MONGO_CEC_CONN }}
    MONGO_CEC_DB: ${{ secrets.MONGO_CEC_DB }}
    APP_PORT: 3001

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint:check

    test:
        name: Test
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test

    compile:
        name: Compile TypeScript
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Compile TypeScript
              run: npm run compile-ts

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [test, compile]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Create .env for build
              run: |
                  echo "MONGO_CEC_ADMIN=${{ secrets.MONGO_CEC_ADMIN }}" >> .env
                  echo "MONGO_CEC_PASS=${{ secrets.MONGO_CEC_PASS }}" >> .env
                  echo "MONGO_CEC_CONN=${{ secrets.MONGO_CEC_CONN }}" >> .env
                  echo "MONGO_CEC_DB=${{ secrets.MONGO_CEC_DB }}" >> .env
                  echo "APP_PORT=${{ env.APP_PORT }}" >> .env
                  echo "SERVER_PORT=5376" >> .env

            - name: Build production bundle
              run: npm run build

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: production-build
                  path: CEC/archive/dist/
                  retention-days: 7
